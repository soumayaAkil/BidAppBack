"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _requireModule = _interopRequireDefault(require("require-module"));

var _Credentials = _interopRequireDefault(require("./Credentials"));

var _JwtGenerator = _interopRequireDefault(require("./JwtGenerator"));

var _HashGenerator = _interopRequireDefault(require("./HashGenerator"));

var _Message = _interopRequireDefault(require("./Message"));

var _Messages = _interopRequireDefault(require("./Messages"));

var _Voice = _interopRequireDefault(require("./Voice"));

var _Number = _interopRequireDefault(require("./Number"));

var _Verify = _interopRequireDefault(require("./Verify"));

var _NumberInsight = _interopRequireDefault(require("./NumberInsight"));

var _App = _interopRequireDefault(require("./App"));

var _Account = _interopRequireDefault(require("./Account"));

var _CallsResource = _interopRequireDefault(require("./CallsResource"));

var _Conversations = _interopRequireDefault(require("./Conversations"));

var _Users = _interopRequireDefault(require("./Users"));

var _FilesResource = _interopRequireDefault(require("./FilesResource"));

var _Conversion = _interopRequireDefault(require("./Conversion"));

var _Media = _interopRequireDefault(require("./Media"));

var _Redact = _interopRequireDefault(require("./Redact"));

var _Channel = _interopRequireDefault(require("./Channel"));

var _Dispatch = _interopRequireDefault(require("./Dispatch"));

var _Pricing = _interopRequireDefault(require("./Pricing"));

var _HttpClient = _interopRequireDefault(require("./HttpClient"));

var _NullLogger = _interopRequireDefault(require("./NullLogger"));

var _ConsoleLogger = _interopRequireDefault(require("./ConsoleLogger"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var jwtGeneratorInstance = new _JwtGenerator.default();
var hashGeneratorInstance = new _HashGenerator.default();

class Vonage {
  /**
   * @param {Credentials} credentials - Vonage API credentials
   * @param {string} credentials.apiKey - the Vonage API key
   * @param {string} credentials.apiSecret - the Vonage API secret
   * @param {Object} options - Additional options
   * @param {boolean} options.debug - `true` to turn on debug logging
   * @param {Object} options.logger - Set a custom logger.
   * @param {string} options.appendToUserAgent - A value to append to the user agent.
   *                    The value will be prefixed with a `/`
   */
  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {
      debug: false
    };
    this.credentials = _Credentials.default.parse(credentials);
    this.options = Object.assign({}, options); // If no logger has been supplied but debug has been set
    // default to using the ConsoleLogger

    if (!this.options.logger && this.options.debug) {
      this.options.logger = new _ConsoleLogger.default();
    } else if (!this.options.logger) {
      // Swallow the logging
      this.options.logger = new _NullLogger.default();
    }

    var userAgent = "@vonage/server-sdk/UNKNOWN node/UNKNOWN";

    try {
      var packageDetails = require(_path.default.join(__dirname, "..", "package.json"));

      userAgent = "@vonage/server-sdk/".concat(packageDetails.version, " node/").concat(process.version.replace("v", ""));
    } catch (e) {
      console.warn("Could not load package details");
    }

    this.options.userAgent = userAgent;

    if (this.options.appendToUserAgent) {
      this.options.userAgent += " ".concat(this.options.appendToUserAgent);
    } // This is legacy, everything should use rest or api going forward


    this.options.httpClient = new _HttpClient.default(Object.assign({
      host: this.options.restHost || "rest.nexmo.com"
    }, this.options), this.credentials); // We have two different hosts, so we use two different HttpClients

    this.options.api = new _HttpClient.default(Object.assign({
      host: this.options.apiHost || "api.nexmo.com"
    }, this.options), this.credentials);
    this.options.rest = new _HttpClient.default(Object.assign({
      host: this.options.restHost || "rest.nexmo.com"
    }, this.options), this.credentials);
    this.message = new _Message.default(this.credentials, this.options);
    this.messages = new _Messages.default(this.credentials, this.options);
    this.voice = new _Voice.default(this.credentials, this.options);
    this.number = new _Number.default(this.credentials, this.options);
    this.verify = new _Verify.default(this.credentials, this.options);
    this.numberInsight = new _NumberInsight.default(this.credentials, this.options);
    this.applications = new _App.default(this.credentials, this.options);
    this.account = new _Account.default(this.credentials, this.options);
    this.calls = new _CallsResource.default(this.credentials, this.options);
    this.conversations = new _Conversations.default(this.credentials, this.options);
    this.users = new _Users.default(this.credentials, this.options);
    this.files = new _FilesResource.default(this.credentials, this.options);
    this.conversion = new _Conversion.default(this.credentials, this.options);
    this.media = new _Media.default(this.credentials, this.options);
    this.redact = new _Redact.default(this.credentials, this.options);
    this.dispatch = new _Dispatch.default(this.credentials, this.options);
    this.pricing = new _Pricing.default(this.credentials, this.options);
    var mapping = [{
      service: "video",
      client: "Video",
      package: "@vonage/video"
    }];

    for (var i = 0; i < mapping.length; i++) {
      try {
        var packageName = mapping[i].package;
        var client = (0, _requireModule.default)(packageName);
        this[mapping[i].service] = new client[mapping[i].client](this.credentials);
      } catch (err) {// do nothing, if we can't load the package assume it's just not there
      }
    }
    /**
     * @deprecated Please use vonage.messages
     */


    this.channel = new _Channel.default(this.credentials, this.options);
    /**
     * @deprecated Please use vonage.applications
     */

    this.app = this.applications;
  }
  /**
   * Generate a JSON Web Token (JWT).
   *
   * The private key used upon Vonage instance construction will be used to sign
   * the JWT. The application_id you used upon Vonage instance creation will be
   * included in the claims for the JWT, however this can be overridden by passing
   * an application_id as part of the claims.
   *
   * @param {Object} claims - name/value pair claims to sign within the JWT
   *
   * @returns {String} the generated token
   */


  generateJwt() {
    var claims = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

    if (claims.application_id === undefined) {
      claims.application_id = this.credentials.applicationId;
    }

    return Vonage.generateJwt(this.credentials.privateKey, claims);
  }
  /**
   * Generate a Signature Hash.
   *
   * @param {Object} params - params to generate hash from
   *
   * @returns {String} the generated token
   */


  generateSignature(params) {
    return this.credentials.generateSignature(params);
  }

}
/**
 * Generate a JSON Web Token (JWT).
 *
 * @param {String|Buffer} privateKey - the path to the private key certificate
 *          to be used when signing the claims.
 * @param {Object} claims - name/value pair claims to sign within the JWT
 *
 * @returns {String} the generated token
 */


Vonage.generateJwt = (privateKey, claims) => {
  if (!(privateKey instanceof Buffer)) {
    if (!_fs.default.existsSync(privateKey)) {
      throw new Error("File \"".concat(privateKey, "\" not found."));
    } else {
      privateKey = _fs.default.readFileSync(privateKey);
    }
  }

  return jwtGeneratorInstance.generate(privateKey, claims);
};
/**
 * Generate a Signature Hash.
 *
 * @param {String} method - the method to be used when creating the hash
 * @param {String} secret - the secret to be used when creating the hash
 * @param {Object} params - params to generate hash from
 *
 * @returns {String} the generated token
 */


Vonage.generateSignature = (method, secret, params) => {
  return hashGeneratorInstance.generate(method, secret, params);
};

var _default = Vonage;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJqd3RHZW5lcmF0b3JJbnN0YW5jZSIsIkp3dEdlbmVyYXRvciIsImhhc2hHZW5lcmF0b3JJbnN0YW5jZSIsIkhhc2hHZW5lcmF0b3IiLCJWb25hZ2UiLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImRlYnVnIiwiQ3JlZGVudGlhbHMiLCJwYXJzZSIsIk9iamVjdCIsImFzc2lnbiIsImxvZ2dlciIsIkNvbnNvbGVMb2dnZXIiLCJOdWxsTG9nZ2VyIiwidXNlckFnZW50IiwicGFja2FnZURldGFpbHMiLCJyZXF1aXJlIiwicGF0aCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJ2ZXJzaW9uIiwicHJvY2VzcyIsInJlcGxhY2UiLCJlIiwiY29uc29sZSIsIndhcm4iLCJhcHBlbmRUb1VzZXJBZ2VudCIsImh0dHBDbGllbnQiLCJIdHRwQ2xpZW50IiwiaG9zdCIsInJlc3RIb3N0IiwiYXBpIiwiYXBpSG9zdCIsInJlc3QiLCJtZXNzYWdlIiwiTWVzc2FnZSIsIm1lc3NhZ2VzIiwiTWVzc2FnZXMiLCJ2b2ljZSIsIlZvaWNlIiwibnVtYmVyIiwiTnVtYmVyIiwidmVyaWZ5IiwiVmVyaWZ5IiwibnVtYmVySW5zaWdodCIsIk51bWJlckluc2lnaHQiLCJhcHBsaWNhdGlvbnMiLCJBcHAiLCJhY2NvdW50IiwiQWNjb3VudCIsImNhbGxzIiwiQ2FsbHNSZXNvdXJjZSIsImNvbnZlcnNhdGlvbnMiLCJDb252ZXJzYXRpb25zIiwidXNlcnMiLCJVc2VycyIsImZpbGVzIiwiRmlsZXNSZXNvdXJjZSIsImNvbnZlcnNpb24iLCJDb252ZXJzaW9uIiwibWVkaWEiLCJNZWRpYSIsInJlZGFjdCIsIlJlZGFjdCIsImRpc3BhdGNoIiwiRGlzcGF0Y2giLCJwcmljaW5nIiwiUHJpY2luZyIsIm1hcHBpbmciLCJzZXJ2aWNlIiwiY2xpZW50IiwicGFja2FnZSIsImkiLCJsZW5ndGgiLCJwYWNrYWdlTmFtZSIsInJlcXVpcmVNb2R1bGUiLCJlcnIiLCJjaGFubmVsIiwiQ2hhbm5lbCIsImFwcCIsImdlbmVyYXRlSnd0IiwiY2xhaW1zIiwiYXBwbGljYXRpb25faWQiLCJ1bmRlZmluZWQiLCJhcHBsaWNhdGlvbklkIiwicHJpdmF0ZUtleSIsImdlbmVyYXRlU2lnbmF0dXJlIiwicGFyYW1zIiwiQnVmZmVyIiwiZnMiLCJleGlzdHNTeW5jIiwiRXJyb3IiLCJyZWFkRmlsZVN5bmMiLCJnZW5lcmF0ZSIsIm1ldGhvZCIsInNlY3JldCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9Wb25hZ2UuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCByZXF1aXJlTW9kdWxlIGZyb20gXCJyZXF1aXJlLW1vZHVsZVwiO1xuXG5pbXBvcnQgQ3JlZGVudGlhbHMgZnJvbSBcIi4vQ3JlZGVudGlhbHNcIjtcbmltcG9ydCBKd3RHZW5lcmF0b3IgZnJvbSBcIi4vSnd0R2VuZXJhdG9yXCI7XG5pbXBvcnQgSGFzaEdlbmVyYXRvciBmcm9tIFwiLi9IYXNoR2VuZXJhdG9yXCI7XG5pbXBvcnQgTWVzc2FnZSBmcm9tIFwiLi9NZXNzYWdlXCI7XG5pbXBvcnQgTWVzc2FnZXMgZnJvbSBcIi4vTWVzc2FnZXNcIjtcbmltcG9ydCBWb2ljZSBmcm9tIFwiLi9Wb2ljZVwiO1xuaW1wb3J0IE51bWJlciBmcm9tIFwiLi9OdW1iZXJcIjtcbmltcG9ydCBWZXJpZnkgZnJvbSBcIi4vVmVyaWZ5XCI7XG5pbXBvcnQgTnVtYmVySW5zaWdodCBmcm9tIFwiLi9OdW1iZXJJbnNpZ2h0XCI7XG5pbXBvcnQgQXBwIGZyb20gXCIuL0FwcFwiO1xuaW1wb3J0IEFjY291bnQgZnJvbSBcIi4vQWNjb3VudFwiO1xuaW1wb3J0IENhbGxzUmVzb3VyY2UgZnJvbSBcIi4vQ2FsbHNSZXNvdXJjZVwiO1xuaW1wb3J0IENvbnZlcnNhdGlvbnMgZnJvbSBcIi4vQ29udmVyc2F0aW9uc1wiO1xuaW1wb3J0IFVzZXJzIGZyb20gXCIuL1VzZXJzXCI7XG5pbXBvcnQgRmlsZXNSZXNvdXJjZSBmcm9tIFwiLi9GaWxlc1Jlc291cmNlXCI7XG5pbXBvcnQgQ29udmVyc2lvbiBmcm9tIFwiLi9Db252ZXJzaW9uXCI7XG5pbXBvcnQgTWVkaWEgZnJvbSBcIi4vTWVkaWFcIjtcbmltcG9ydCBSZWRhY3QgZnJvbSBcIi4vUmVkYWN0XCI7XG5pbXBvcnQgQ2hhbm5lbCBmcm9tIFwiLi9DaGFubmVsXCI7XG5pbXBvcnQgRGlzcGF0Y2ggZnJvbSBcIi4vRGlzcGF0Y2hcIjtcbmltcG9ydCBQcmljaW5nIGZyb20gXCIuL1ByaWNpbmdcIjtcbmltcG9ydCBIdHRwQ2xpZW50IGZyb20gXCIuL0h0dHBDbGllbnRcIjtcbmltcG9ydCBOdWxsTG9nZ2VyIGZyb20gXCIuL051bGxMb2dnZXJcIjtcbmltcG9ydCBDb25zb2xlTG9nZ2VyIGZyb20gXCIuL0NvbnNvbGVMb2dnZXJcIjtcblxuY29uc3Qgand0R2VuZXJhdG9ySW5zdGFuY2UgPSBuZXcgSnd0R2VuZXJhdG9yKCk7XG5jb25zdCBoYXNoR2VuZXJhdG9ySW5zdGFuY2UgPSBuZXcgSGFzaEdlbmVyYXRvcigpO1xuXG5jbGFzcyBWb25hZ2Uge1xuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHMgLSBWb25hZ2UgQVBJIGNyZWRlbnRpYWxzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjcmVkZW50aWFscy5hcGlLZXkgLSB0aGUgVm9uYWdlIEFQSSBrZXlcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNyZWRlbnRpYWxzLmFwaVNlY3JldCAtIHRoZSBWb25hZ2UgQVBJIHNlY3JldFxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9ucyAtIEFkZGl0aW9uYWwgb3B0aW9uc1xuICAgKiBAcGFyYW0ge2Jvb2xlYW59IG9wdGlvbnMuZGVidWcgLSBgdHJ1ZWAgdG8gdHVybiBvbiBkZWJ1ZyBsb2dnaW5nXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLmxvZ2dlciAtIFNldCBhIGN1c3RvbSBsb2dnZXIuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBvcHRpb25zLmFwcGVuZFRvVXNlckFnZW50IC0gQSB2YWx1ZSB0byBhcHBlbmQgdG8gdGhlIHVzZXIgYWdlbnQuXG4gICAqICAgICAgICAgICAgICAgICAgICBUaGUgdmFsdWUgd2lsbCBiZSBwcmVmaXhlZCB3aXRoIGEgYC9gXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHsgZGVidWc6IGZhbHNlIH0pIHtcbiAgICB0aGlzLmNyZWRlbnRpYWxzID0gQ3JlZGVudGlhbHMucGFyc2UoY3JlZGVudGlhbHMpO1xuICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xuXG4gICAgLy8gSWYgbm8gbG9nZ2VyIGhhcyBiZWVuIHN1cHBsaWVkIGJ1dCBkZWJ1ZyBoYXMgYmVlbiBzZXRcbiAgICAvLyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBDb25zb2xlTG9nZ2VyXG4gICAgaWYgKCF0aGlzLm9wdGlvbnMubG9nZ2VyICYmIHRoaXMub3B0aW9ucy5kZWJ1Zykge1xuICAgICAgdGhpcy5vcHRpb25zLmxvZ2dlciA9IG5ldyBDb25zb2xlTG9nZ2VyKCk7XG4gICAgfSBlbHNlIGlmICghdGhpcy5vcHRpb25zLmxvZ2dlcikge1xuICAgICAgLy8gU3dhbGxvdyB0aGUgbG9nZ2luZ1xuICAgICAgdGhpcy5vcHRpb25zLmxvZ2dlciA9IG5ldyBOdWxsTG9nZ2VyKCk7XG4gICAgfVxuXG4gICAgbGV0IHVzZXJBZ2VudCA9IFwiQHZvbmFnZS9zZXJ2ZXItc2RrL1VOS05PV04gbm9kZS9VTktOT1dOXCI7XG4gICAgdHJ5IHtcbiAgICAgIHZhciBwYWNrYWdlRGV0YWlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgXCIuLlwiLCBcInBhY2thZ2UuanNvblwiKSk7XG4gICAgICB1c2VyQWdlbnQgPSBgQHZvbmFnZS9zZXJ2ZXItc2RrLyR7XG4gICAgICAgIHBhY2thZ2VEZXRhaWxzLnZlcnNpb25cbiAgICAgIH0gbm9kZS8ke3Byb2Nlc3MudmVyc2lvbi5yZXBsYWNlKFwidlwiLCBcIlwiKX1gO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIkNvdWxkIG5vdCBsb2FkIHBhY2thZ2UgZGV0YWlsc1wiKTtcbiAgICB9XG4gICAgdGhpcy5vcHRpb25zLnVzZXJBZ2VudCA9IHVzZXJBZ2VudDtcbiAgICBpZiAodGhpcy5vcHRpb25zLmFwcGVuZFRvVXNlckFnZW50KSB7XG4gICAgICB0aGlzLm9wdGlvbnMudXNlckFnZW50ICs9IGAgJHt0aGlzLm9wdGlvbnMuYXBwZW5kVG9Vc2VyQWdlbnR9YDtcbiAgICB9XG5cbiAgICAvLyBUaGlzIGlzIGxlZ2FjeSwgZXZlcnl0aGluZyBzaG91bGQgdXNlIHJlc3Qgb3IgYXBpIGdvaW5nIGZvcndhcmRcbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudCA9IG5ldyBIdHRwQ2xpZW50KFxuICAgICAgT2JqZWN0LmFzc2lnbihcbiAgICAgICAgeyBob3N0OiB0aGlzLm9wdGlvbnMucmVzdEhvc3QgfHwgXCJyZXN0Lm5leG1vLmNvbVwiIH0sXG4gICAgICAgIHRoaXMub3B0aW9uc1xuICAgICAgKSxcbiAgICAgIHRoaXMuY3JlZGVudGlhbHNcbiAgICApO1xuXG4gICAgLy8gV2UgaGF2ZSB0d28gZGlmZmVyZW50IGhvc3RzLCBzbyB3ZSB1c2UgdHdvIGRpZmZlcmVudCBIdHRwQ2xpZW50c1xuICAgIHRoaXMub3B0aW9ucy5hcGkgPSBuZXcgSHR0cENsaWVudChcbiAgICAgIE9iamVjdC5hc3NpZ24oXG4gICAgICAgIHsgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIgfSxcbiAgICAgICAgdGhpcy5vcHRpb25zXG4gICAgICApLFxuICAgICAgdGhpcy5jcmVkZW50aWFsc1xuICAgICk7XG4gICAgdGhpcy5vcHRpb25zLnJlc3QgPSBuZXcgSHR0cENsaWVudChcbiAgICAgIE9iamVjdC5hc3NpZ24oXG4gICAgICAgIHsgaG9zdDogdGhpcy5vcHRpb25zLnJlc3RIb3N0IHx8IFwicmVzdC5uZXhtby5jb21cIiB9LFxuICAgICAgICB0aGlzLm9wdGlvbnNcbiAgICAgICksXG4gICAgICB0aGlzLmNyZWRlbnRpYWxzXG4gICAgKTtcblxuICAgIHRoaXMubWVzc2FnZSA9IG5ldyBNZXNzYWdlKHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5tZXNzYWdlcyA9IG5ldyBNZXNzYWdlcyh0aGlzLmNyZWRlbnRpYWxzLCB0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMudm9pY2UgPSBuZXcgVm9pY2UodGhpcy5jcmVkZW50aWFscywgdGhpcy5vcHRpb25zKTtcbiAgICB0aGlzLm51bWJlciA9IG5ldyBOdW1iZXIodGhpcy5jcmVkZW50aWFscywgdGhpcy5vcHRpb25zKTtcbiAgICB0aGlzLnZlcmlmeSA9IG5ldyBWZXJpZnkodGhpcy5jcmVkZW50aWFscywgdGhpcy5vcHRpb25zKTtcbiAgICB0aGlzLm51bWJlckluc2lnaHQgPSBuZXcgTnVtYmVySW5zaWdodCh0aGlzLmNyZWRlbnRpYWxzLCB0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMuYXBwbGljYXRpb25zID0gbmV3IEFwcCh0aGlzLmNyZWRlbnRpYWxzLCB0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMuYWNjb3VudCA9IG5ldyBBY2NvdW50KHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5jYWxscyA9IG5ldyBDYWxsc1Jlc291cmNlKHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5jb252ZXJzYXRpb25zID0gbmV3IENvbnZlcnNhdGlvbnModGhpcy5jcmVkZW50aWFscywgdGhpcy5vcHRpb25zKTtcbiAgICB0aGlzLnVzZXJzID0gbmV3IFVzZXJzKHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5maWxlcyA9IG5ldyBGaWxlc1Jlc291cmNlKHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5jb252ZXJzaW9uID0gbmV3IENvbnZlcnNpb24odGhpcy5jcmVkZW50aWFscywgdGhpcy5vcHRpb25zKTtcbiAgICB0aGlzLm1lZGlhID0gbmV3IE1lZGlhKHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5yZWRhY3QgPSBuZXcgUmVkYWN0KHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG4gICAgdGhpcy5kaXNwYXRjaCA9IG5ldyBEaXNwYXRjaCh0aGlzLmNyZWRlbnRpYWxzLCB0aGlzLm9wdGlvbnMpO1xuICAgIHRoaXMucHJpY2luZyA9IG5ldyBQcmljaW5nKHRoaXMuY3JlZGVudGlhbHMsIHRoaXMub3B0aW9ucyk7XG5cbiAgICBjb25zdCBtYXBwaW5nID0gW1xuICAgICAgeyBzZXJ2aWNlOiBcInZpZGVvXCIsIGNsaWVudDogXCJWaWRlb1wiLCBwYWNrYWdlOiBcIkB2b25hZ2UvdmlkZW9cIiB9LFxuICAgIF07XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1hcHBpbmcubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCBwYWNrYWdlTmFtZSA9IG1hcHBpbmdbaV0ucGFja2FnZTtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gcmVxdWlyZU1vZHVsZShwYWNrYWdlTmFtZSk7XG4gICAgICAgIHRoaXNbbWFwcGluZ1tpXS5zZXJ2aWNlXSA9IG5ldyBjbGllbnRbbWFwcGluZ1tpXS5jbGllbnRdKFxuICAgICAgICAgIHRoaXMuY3JlZGVudGlhbHNcbiAgICAgICAgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBkbyBub3RoaW5nLCBpZiB3ZSBjYW4ndCBsb2FkIHRoZSBwYWNrYWdlIGFzc3VtZSBpdCdzIGp1c3Qgbm90IHRoZXJlXG4gICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGRlcHJlY2F0ZWQgUGxlYXNlIHVzZSB2b25hZ2UubWVzc2FnZXNcbiAgICAgKi9cbiAgICB0aGlzLmNoYW5uZWwgPSBuZXcgQ2hhbm5lbCh0aGlzLmNyZWRlbnRpYWxzLCB0aGlzLm9wdGlvbnMpO1xuXG4gICAgLyoqXG4gICAgICogQGRlcHJlY2F0ZWQgUGxlYXNlIHVzZSB2b25hZ2UuYXBwbGljYXRpb25zXG4gICAgICovXG4gICAgdGhpcy5hcHAgPSB0aGlzLmFwcGxpY2F0aW9ucztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIEpTT04gV2ViIFRva2VuIChKV1QpLlxuICAgKlxuICAgKiBUaGUgcHJpdmF0ZSBrZXkgdXNlZCB1cG9uIFZvbmFnZSBpbnN0YW5jZSBjb25zdHJ1Y3Rpb24gd2lsbCBiZSB1c2VkIHRvIHNpZ25cbiAgICogdGhlIEpXVC4gVGhlIGFwcGxpY2F0aW9uX2lkIHlvdSB1c2VkIHVwb24gVm9uYWdlIGluc3RhbmNlIGNyZWF0aW9uIHdpbGwgYmVcbiAgICogaW5jbHVkZWQgaW4gdGhlIGNsYWltcyBmb3IgdGhlIEpXVCwgaG93ZXZlciB0aGlzIGNhbiBiZSBvdmVycmlkZGVuIGJ5IHBhc3NpbmdcbiAgICogYW4gYXBwbGljYXRpb25faWQgYXMgcGFydCBvZiB0aGUgY2xhaW1zLlxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gY2xhaW1zIC0gbmFtZS92YWx1ZSBwYWlyIGNsYWltcyB0byBzaWduIHdpdGhpbiB0aGUgSldUXG4gICAqXG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IHRoZSBnZW5lcmF0ZWQgdG9rZW5cbiAgICovXG5cbiAgZ2VuZXJhdGVKd3QoY2xhaW1zID0ge30pIHtcbiAgICBpZiAoY2xhaW1zLmFwcGxpY2F0aW9uX2lkID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGNsYWltcy5hcHBsaWNhdGlvbl9pZCA9IHRoaXMuY3JlZGVudGlhbHMuYXBwbGljYXRpb25JZDtcbiAgICB9XG4gICAgcmV0dXJuIFZvbmFnZS5nZW5lcmF0ZUp3dCh0aGlzLmNyZWRlbnRpYWxzLnByaXZhdGVLZXksIGNsYWltcyk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgYSBTaWduYXR1cmUgSGFzaC5cbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IHBhcmFtcyAtIHBhcmFtcyB0byBnZW5lcmF0ZSBoYXNoIGZyb21cbiAgICpcbiAgICogQHJldHVybnMge1N0cmluZ30gdGhlIGdlbmVyYXRlZCB0b2tlblxuICAgKi9cbiAgZ2VuZXJhdGVTaWduYXR1cmUocGFyYW1zKSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlZGVudGlhbHMuZ2VuZXJhdGVTaWduYXR1cmUocGFyYW1zKTtcbiAgfVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIGEgSlNPTiBXZWIgVG9rZW4gKEpXVCkuXG4gKlxuICogQHBhcmFtIHtTdHJpbmd8QnVmZmVyfSBwcml2YXRlS2V5IC0gdGhlIHBhdGggdG8gdGhlIHByaXZhdGUga2V5IGNlcnRpZmljYXRlXG4gKiAgICAgICAgICB0byBiZSB1c2VkIHdoZW4gc2lnbmluZyB0aGUgY2xhaW1zLlxuICogQHBhcmFtIHtPYmplY3R9IGNsYWltcyAtIG5hbWUvdmFsdWUgcGFpciBjbGFpbXMgdG8gc2lnbiB3aXRoaW4gdGhlIEpXVFxuICpcbiAqIEByZXR1cm5zIHtTdHJpbmd9IHRoZSBnZW5lcmF0ZWQgdG9rZW5cbiAqL1xuVm9uYWdlLmdlbmVyYXRlSnd0ID0gKHByaXZhdGVLZXksIGNsYWltcykgPT4ge1xuICBpZiAoIShwcml2YXRlS2V5IGluc3RhbmNlb2YgQnVmZmVyKSkge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhwcml2YXRlS2V5KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIFwiJHtwcml2YXRlS2V5fVwiIG5vdCBmb3VuZC5gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJpdmF0ZUtleSA9IGZzLnJlYWRGaWxlU3luYyhwcml2YXRlS2V5KTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGp3dEdlbmVyYXRvckluc3RhbmNlLmdlbmVyYXRlKHByaXZhdGVLZXksIGNsYWltcyk7XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlIGEgU2lnbmF0dXJlIEhhc2guXG4gKlxuICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCAtIHRoZSBtZXRob2QgdG8gYmUgdXNlZCB3aGVuIGNyZWF0aW5nIHRoZSBoYXNoXG4gKiBAcGFyYW0ge1N0cmluZ30gc2VjcmV0IC0gdGhlIHNlY3JldCB0byBiZSB1c2VkIHdoZW4gY3JlYXRpbmcgdGhlIGhhc2hcbiAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgLSBwYXJhbXMgdG8gZ2VuZXJhdGUgaGFzaCBmcm9tXG4gKlxuICogQHJldHVybnMge1N0cmluZ30gdGhlIGdlbmVyYXRlZCB0b2tlblxuICovXG5Wb25hZ2UuZ2VuZXJhdGVTaWduYXR1cmUgPSAobWV0aG9kLCBzZWNyZXQsIHBhcmFtcykgPT4ge1xuICByZXR1cm4gaGFzaEdlbmVyYXRvckluc3RhbmNlLmdlbmVyYXRlKG1ldGhvZCwgc2VjcmV0LCBwYXJhbXMpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgVm9uYWdlO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFNQSxvQkFBb0IsR0FBRyxJQUFJQyxxQkFBSixFQUE3QjtBQUNBLElBQU1DLHFCQUFxQixHQUFHLElBQUlDLHNCQUFKLEVBQTlCOztBQUVBLE1BQU1DLE1BQU4sQ0FBYTtFQUNYO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0VBQ0VDLFdBQVcsQ0FBQ0MsV0FBRCxFQUEwQztJQUFBLElBQTVCQyxPQUE0Qix1RUFBbEI7TUFBRUMsS0FBSyxFQUFFO0lBQVQsQ0FBa0I7SUFDbkQsS0FBS0YsV0FBTCxHQUFtQkcsb0JBQUEsQ0FBWUMsS0FBWixDQUFrQkosV0FBbEIsQ0FBbkI7SUFDQSxLQUFLQyxPQUFMLEdBQWVJLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JMLE9BQWxCLENBQWYsQ0FGbUQsQ0FJbkQ7SUFDQTs7SUFDQSxJQUFJLENBQUMsS0FBS0EsT0FBTCxDQUFhTSxNQUFkLElBQXdCLEtBQUtOLE9BQUwsQ0FBYUMsS0FBekMsRUFBZ0Q7TUFDOUMsS0FBS0QsT0FBTCxDQUFhTSxNQUFiLEdBQXNCLElBQUlDLHNCQUFKLEVBQXRCO0lBQ0QsQ0FGRCxNQUVPLElBQUksQ0FBQyxLQUFLUCxPQUFMLENBQWFNLE1BQWxCLEVBQTBCO01BQy9CO01BQ0EsS0FBS04sT0FBTCxDQUFhTSxNQUFiLEdBQXNCLElBQUlFLG1CQUFKLEVBQXRCO0lBQ0Q7O0lBRUQsSUFBSUMsU0FBUyxHQUFHLHlDQUFoQjs7SUFDQSxJQUFJO01BQ0YsSUFBSUMsY0FBYyxHQUFHQyxPQUFPLENBQUNDLGFBQUEsQ0FBS0MsSUFBTCxDQUFVQyxTQUFWLEVBQXFCLElBQXJCLEVBQTJCLGNBQTNCLENBQUQsQ0FBNUI7O01BQ0FMLFNBQVMsZ0NBQ1BDLGNBQWMsQ0FBQ0ssT0FEUixtQkFFQUMsT0FBTyxDQUFDRCxPQUFSLENBQWdCRSxPQUFoQixDQUF3QixHQUF4QixFQUE2QixFQUE3QixDQUZBLENBQVQ7SUFHRCxDQUxELENBS0UsT0FBT0MsQ0FBUCxFQUFVO01BQ1ZDLE9BQU8sQ0FBQ0MsSUFBUixDQUFhLGdDQUFiO0lBQ0Q7O0lBQ0QsS0FBS3BCLE9BQUwsQ0FBYVMsU0FBYixHQUF5QkEsU0FBekI7O0lBQ0EsSUFBSSxLQUFLVCxPQUFMLENBQWFxQixpQkFBakIsRUFBb0M7TUFDbEMsS0FBS3JCLE9BQUwsQ0FBYVMsU0FBYixlQUE4QixLQUFLVCxPQUFMLENBQWFxQixpQkFBM0M7SUFDRCxDQXpCa0QsQ0EyQm5EOzs7SUFDQSxLQUFLckIsT0FBTCxDQUFhc0IsVUFBYixHQUEwQixJQUFJQyxtQkFBSixDQUN4Qm5CLE1BQU0sQ0FBQ0MsTUFBUCxDQUNFO01BQUVtQixJQUFJLEVBQUUsS0FBS3hCLE9BQUwsQ0FBYXlCLFFBQWIsSUFBeUI7SUFBakMsQ0FERixFQUVFLEtBQUt6QixPQUZQLENBRHdCLEVBS3hCLEtBQUtELFdBTG1CLENBQTFCLENBNUJtRCxDQW9DbkQ7O0lBQ0EsS0FBS0MsT0FBTCxDQUFhMEIsR0FBYixHQUFtQixJQUFJSCxtQkFBSixDQUNqQm5CLE1BQU0sQ0FBQ0MsTUFBUCxDQUNFO01BQUVtQixJQUFJLEVBQUUsS0FBS3hCLE9BQUwsQ0FBYTJCLE9BQWIsSUFBd0I7SUFBaEMsQ0FERixFQUVFLEtBQUszQixPQUZQLENBRGlCLEVBS2pCLEtBQUtELFdBTFksQ0FBbkI7SUFPQSxLQUFLQyxPQUFMLENBQWE0QixJQUFiLEdBQW9CLElBQUlMLG1CQUFKLENBQ2xCbkIsTUFBTSxDQUFDQyxNQUFQLENBQ0U7TUFBRW1CLElBQUksRUFBRSxLQUFLeEIsT0FBTCxDQUFheUIsUUFBYixJQUF5QjtJQUFqQyxDQURGLEVBRUUsS0FBS3pCLE9BRlAsQ0FEa0IsRUFLbEIsS0FBS0QsV0FMYSxDQUFwQjtJQVFBLEtBQUs4QixPQUFMLEdBQWUsSUFBSUMsZ0JBQUosQ0FBWSxLQUFLL0IsV0FBakIsRUFBOEIsS0FBS0MsT0FBbkMsQ0FBZjtJQUNBLEtBQUsrQixRQUFMLEdBQWdCLElBQUlDLGlCQUFKLENBQWEsS0FBS2pDLFdBQWxCLEVBQStCLEtBQUtDLE9BQXBDLENBQWhCO0lBQ0EsS0FBS2lDLEtBQUwsR0FBYSxJQUFJQyxjQUFKLENBQVUsS0FBS25DLFdBQWYsRUFBNEIsS0FBS0MsT0FBakMsQ0FBYjtJQUNBLEtBQUttQyxNQUFMLEdBQWMsSUFBSUMsZUFBSixDQUFXLEtBQUtyQyxXQUFoQixFQUE2QixLQUFLQyxPQUFsQyxDQUFkO0lBQ0EsS0FBS3FDLE1BQUwsR0FBYyxJQUFJQyxlQUFKLENBQVcsS0FBS3ZDLFdBQWhCLEVBQTZCLEtBQUtDLE9BQWxDLENBQWQ7SUFDQSxLQUFLdUMsYUFBTCxHQUFxQixJQUFJQyxzQkFBSixDQUFrQixLQUFLekMsV0FBdkIsRUFBb0MsS0FBS0MsT0FBekMsQ0FBckI7SUFDQSxLQUFLeUMsWUFBTCxHQUFvQixJQUFJQyxZQUFKLENBQVEsS0FBSzNDLFdBQWIsRUFBMEIsS0FBS0MsT0FBL0IsQ0FBcEI7SUFDQSxLQUFLMkMsT0FBTCxHQUFlLElBQUlDLGdCQUFKLENBQVksS0FBSzdDLFdBQWpCLEVBQThCLEtBQUtDLE9BQW5DLENBQWY7SUFDQSxLQUFLNkMsS0FBTCxHQUFhLElBQUlDLHNCQUFKLENBQWtCLEtBQUsvQyxXQUF2QixFQUFvQyxLQUFLQyxPQUF6QyxDQUFiO0lBQ0EsS0FBSytDLGFBQUwsR0FBcUIsSUFBSUMsc0JBQUosQ0FBa0IsS0FBS2pELFdBQXZCLEVBQW9DLEtBQUtDLE9BQXpDLENBQXJCO0lBQ0EsS0FBS2lELEtBQUwsR0FBYSxJQUFJQyxjQUFKLENBQVUsS0FBS25ELFdBQWYsRUFBNEIsS0FBS0MsT0FBakMsQ0FBYjtJQUNBLEtBQUttRCxLQUFMLEdBQWEsSUFBSUMsc0JBQUosQ0FBa0IsS0FBS3JELFdBQXZCLEVBQW9DLEtBQUtDLE9BQXpDLENBQWI7SUFDQSxLQUFLcUQsVUFBTCxHQUFrQixJQUFJQyxtQkFBSixDQUFlLEtBQUt2RCxXQUFwQixFQUFpQyxLQUFLQyxPQUF0QyxDQUFsQjtJQUNBLEtBQUt1RCxLQUFMLEdBQWEsSUFBSUMsY0FBSixDQUFVLEtBQUt6RCxXQUFmLEVBQTRCLEtBQUtDLE9BQWpDLENBQWI7SUFDQSxLQUFLeUQsTUFBTCxHQUFjLElBQUlDLGVBQUosQ0FBVyxLQUFLM0QsV0FBaEIsRUFBNkIsS0FBS0MsT0FBbEMsQ0FBZDtJQUNBLEtBQUsyRCxRQUFMLEdBQWdCLElBQUlDLGlCQUFKLENBQWEsS0FBSzdELFdBQWxCLEVBQStCLEtBQUtDLE9BQXBDLENBQWhCO0lBQ0EsS0FBSzZELE9BQUwsR0FBZSxJQUFJQyxnQkFBSixDQUFZLEtBQUsvRCxXQUFqQixFQUE4QixLQUFLQyxPQUFuQyxDQUFmO0lBRUEsSUFBTStELE9BQU8sR0FBRyxDQUNkO01BQUVDLE9BQU8sRUFBRSxPQUFYO01BQW9CQyxNQUFNLEVBQUUsT0FBNUI7TUFBcUNDLE9BQU8sRUFBRTtJQUE5QyxDQURjLENBQWhCOztJQUlBLEtBQUssSUFBSUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR0osT0FBTyxDQUFDSyxNQUE1QixFQUFvQ0QsQ0FBQyxFQUFyQyxFQUF5QztNQUN2QyxJQUFJO1FBQ0YsSUFBSUUsV0FBVyxHQUFHTixPQUFPLENBQUNJLENBQUQsQ0FBUCxDQUFXRCxPQUE3QjtRQUNBLElBQU1ELE1BQU0sR0FBRyxJQUFBSyxzQkFBQSxFQUFjRCxXQUFkLENBQWY7UUFDQSxLQUFLTixPQUFPLENBQUNJLENBQUQsQ0FBUCxDQUFXSCxPQUFoQixJQUEyQixJQUFJQyxNQUFNLENBQUNGLE9BQU8sQ0FBQ0ksQ0FBRCxDQUFQLENBQVdGLE1BQVosQ0FBVixDQUN6QixLQUFLbEUsV0FEb0IsQ0FBM0I7TUFHRCxDQU5ELENBTUUsT0FBT3dFLEdBQVAsRUFBWSxDQUNaO01BQ0Q7SUFDRjtJQUVEO0FBQ0o7QUFDQTs7O0lBQ0ksS0FBS0MsT0FBTCxHQUFlLElBQUlDLGdCQUFKLENBQVksS0FBSzFFLFdBQWpCLEVBQThCLEtBQUtDLE9BQW5DLENBQWY7SUFFQTtBQUNKO0FBQ0E7O0lBQ0ksS0FBSzBFLEdBQUwsR0FBVyxLQUFLakMsWUFBaEI7RUFDRDtFQUVEO0FBQ0Y7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0VBRUVrQyxXQUFXLEdBQWM7SUFBQSxJQUFiQyxNQUFhLHVFQUFKLEVBQUk7O0lBQ3ZCLElBQUlBLE1BQU0sQ0FBQ0MsY0FBUCxLQUEwQkMsU0FBOUIsRUFBeUM7TUFDdkNGLE1BQU0sQ0FBQ0MsY0FBUCxHQUF3QixLQUFLOUUsV0FBTCxDQUFpQmdGLGFBQXpDO0lBQ0Q7O0lBQ0QsT0FBT2xGLE1BQU0sQ0FBQzhFLFdBQVAsQ0FBbUIsS0FBSzVFLFdBQUwsQ0FBaUJpRixVQUFwQyxFQUFnREosTUFBaEQsQ0FBUDtFQUNEO0VBRUQ7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztFQUNFSyxpQkFBaUIsQ0FBQ0MsTUFBRCxFQUFTO0lBQ3hCLE9BQU8sS0FBS25GLFdBQUwsQ0FBaUJrRixpQkFBakIsQ0FBbUNDLE1BQW5DLENBQVA7RUFDRDs7QUF6SVU7QUE0SWI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQXJGLE1BQU0sQ0FBQzhFLFdBQVAsR0FBcUIsQ0FBQ0ssVUFBRCxFQUFhSixNQUFiLEtBQXdCO0VBQzNDLElBQUksRUFBRUksVUFBVSxZQUFZRyxNQUF4QixDQUFKLEVBQXFDO0lBQ25DLElBQUksQ0FBQ0MsV0FBQSxDQUFHQyxVQUFILENBQWNMLFVBQWQsQ0FBTCxFQUFnQztNQUM5QixNQUFNLElBQUlNLEtBQUosa0JBQW1CTixVQUFuQixtQkFBTjtJQUNELENBRkQsTUFFTztNQUNMQSxVQUFVLEdBQUdJLFdBQUEsQ0FBR0csWUFBSCxDQUFnQlAsVUFBaEIsQ0FBYjtJQUNEO0VBQ0Y7O0VBQ0QsT0FBT3ZGLG9CQUFvQixDQUFDK0YsUUFBckIsQ0FBOEJSLFVBQTlCLEVBQTBDSixNQUExQyxDQUFQO0FBQ0QsQ0FURDtBQVdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0EvRSxNQUFNLENBQUNvRixpQkFBUCxHQUEyQixDQUFDUSxNQUFELEVBQVNDLE1BQVQsRUFBaUJSLE1BQWpCLEtBQTRCO0VBQ3JELE9BQU92RixxQkFBcUIsQ0FBQzZGLFFBQXRCLENBQStCQyxNQUEvQixFQUF1Q0MsTUFBdkMsRUFBK0NSLE1BQS9DLENBQVA7QUFDRCxDQUZEOztlQUllckYsTSJ9